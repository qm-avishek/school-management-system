name: Deploy School Management System

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'

jobs:
  deploy-backend:
    name: Deploy Backend to Railway
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Install Backend Dependencies
      run: |
        cd backend
        npm install
        
    - name: Deploy Backend to Railway
      uses: bervProject/railway-deploy@main
      env:
        RAILWAY_TOKEN: 2c291c17-9581-44f9-89a0-0da65976bead
      with:
        service: 64c7d8db-5b5c-4f0b-82e8-32d7e911a874
        detach: false
        
    - name: Test Backend Health
      run: |
        echo "Backend deployment completed!"
        echo "Testing health endpoint..."
        sleep 30
        curl -f https://sms-service.up.railway.app/health || echo "Health check will be available after full deployment"

  deploy-frontend:
    name: Deploy Frontend to Vercel
    runs-on: ubuntu-latest
    needs: deploy-backend
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Deploy Frontend to Vercel
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: Wcy6d56q7FEBKup6677RqcwP
        vercel-org-id: avishek-kumars-projects
        vercel-project-id: prj_RLZw3QVlINTR6P6nrlUTdEh7y6fL
        working-directory: ./frontend
        vercel-args: '--prod'
      env:
        REACT_APP_API_URL: https://sms-service.up.railway.app/api
        GENERATE_SOURCEMAP: false
        
    - name: Deployment Summary
      run: |
        echo "ðŸš€ Deployment Complete!"
        echo "Frontend: https://prj_RLZw3QVlINTR6P6nrlUTdEh7y6fL.vercel.app"
        echo "Backend: https://sms-service.up.railway.app"
        echo "Health Check: https://sms-service.up.railway.app/health"
        echo "Login: admin@ssgb.edu / admin123"
